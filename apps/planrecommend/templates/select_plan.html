{% extends "base.html" %}

{% load static %}
{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'planrecommend/plan.css' %}">
{% endblock %}

{% block content %}
<p id="select-page" class="mb-4" style="color: #1F66F0; font-weight: bold; text-align: center;">5/5</p>
<div class="card mb-4 mt-3 center shadow-sm" style="width: 30%; margin: 0 auto; text-align: center;">
    <div class="card-body">
        <i class="bi bi-map-fill"></i>
        <h3 class="mt-4">선호하는 여행 일정은?</h3>
        <p id="select-map" class="mb-4">선택해주신 스타일로 일정을 만들어드려요.</p>
        
        <!-- 여행일정 선택 -->
        <div class="center" style="display: flex; justify-content: center;">
            <div>
                {% for plan in plans %}
                    <button class="plan-box">{{ plan.plan }}</button>
                {% endfor %}
            </div>
        </div>

        <!-- 선택된 값 -->
        <p class="mt-2 mb-4" style="color: #000000; font-weight: bold; text-align: center;">선택</p>
        <div id="selected-data-container" class="mt-2 mb-4" style="display: flex; flex-direction: column; align-items: center;">
            <div style="display: flex; justify-content: center;">
                <div id="city-selected-data" class="selected-data"></div>   
                <div id="date-selected-data" class="selected-data"></div>  
                <div id="who-selected-data" class="selected-data"></div>    
            </div>
            <div style="display: flex; justify-content: center;">
                <div id="style-selected-data" class="selected-data"></div>    
                <div id="plan-selected-data" class="selected-data"></div>    
            </div>
        </div>
        

        <!-- 다음 버튼 -->
        <div class="center mt-3 mb-3">
            <button id="next-button" class="btn btn-primary" style="width: 370px; height: 50px;">일정추천</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const buttons = document.querySelectorAll('.plan-box');
        const planSelectedDataContainer = document.getElementById('plan-selected-data');
        const styleSelectedDataContainer = document.getElementById('style-selected-data');
        const whoSelectedDataContainer = document.getElementById('who-selected-data');
        const dateSelectedDataContainer = document.getElementById('date-selected-data');
        const citySelectedDataContainer = document.getElementById('city-selected-data');
        const nextButton = document.getElementById('next-button');
        const style = new URLSearchParams(window.location.search).get('style');
        const who = new URLSearchParams(window.location.search).get('who');
        const date = new URLSearchParams(window.location.search).get('date');
        const city = new URLSearchParams(window.location.search).get('city');
        let selectedPlan = '';

        // 선택된 도시를 city-selected-data에 표시
        citySelectedDataContainer.innerHTML = `<div class="city-selected-data">${city}</div>`;

        // 선택된 여행시기를 date-selected-data에 표시
        dateSelectedDataContainer.innerHTML = `<div class="date-selected-data">${date}</div>`;

        // 선택된 동행자를 who-selected-data에 표시
        whoSelectedDataContainer.innerHTML = `<div class="who-selected-data">${who}</div>`;

        // 선택된 스타일을 style-selected-data에 표시
        styleSelectedDataContainer.innerHTML = `<div class="style-selected-data">${style}</div>`;

        function handlePlanSelection(event) {
            // 모든 버튼에서 selected 클래스 제거
            buttons.forEach(btn => btn.classList.remove('selected'));
            // 클릭된 버튼에 selected 클래스 추가
            event.currentTarget.classList.add('selected');
            // 선택된 스타일 저장 및 표시
            selectedPlan = event.currentTarget.textContent;
            planSelectedDataContainer.innerHTML = `<div class="plan-selected-data">${selectedPlan}</div>`;
            
        }

        function handleNextButtonClick(event) {
            if (selectedPlan) {
                // 다음 페이지로 이동하면서 선택된 도시, 여행기간, 동행자, 스타일, 여행일정을 URL 파라미터로 전달
                window.location.href = `{% url 'planrecommend:preparing' %}?city=${encodeURIComponent(city)}&date=${encodeURIComponent(date)}&who=${encodeURIComponent(who)}&style=${encodeURIComponent(style)}&plan=${encodeURIComponent(selectedPlan)}`;
            } else {
                // 선택된 여행일정이 없을 경우, 알림창 띄우기
                alert('여행일정을 선택해주세요.');
                // 기본 동작 방지
                event.preventDefault();
            }
        }

        buttons.forEach(button => button.addEventListener('click', handlePlanSelection));
        nextButton.addEventListener('click', handleNextButtonClick);
    });
</script>
{% endblock %}